<?php
/**
 * @see \Soutenance\Controller\EngagementImpartialiteController::engagementImpartialiteAction()
 *
 * @var These|HDR $object
 * @var Proposition $proposition
 * @var Membre $membre
 * @var ValidationThese|ValidationHDR $validation
 * @var ActeurThese[]|ActeurHDR[] $encadrants
 * @var string $urlSigner
 * @var string $urlRefuser
 * @var string $urlAnnuler
 * @var Rendu $texteEngagement
 * @var string $typeProposition
 */

use Acteur\Entity\Db\ActeurHDR;
use HDR\Entity\Db\HDR;
use Acteur\Entity\Db\ActeurThese;
use These\Entity\Db\These;
use Validation\Entity\Db\TypeValidation;
use Validation\Entity\Db\ValidationHDR;
use Validation\Entity\Db\ValidationThese;
use Soutenance\Entity\Membre;
use Soutenance\Entity\Proposition;
use Soutenance\Provider\Privilege\EngagementImpartialitePrivileges;
use UnicaenRenderer\Entity\Db\Rendu;

/**
 * La validation CODE_ENGAGEMENT_IMPARTIALITE fait office de signature électronique de l'engagement d'impartilité. Par
 * conséquent :
 *  - seul le rapporteur connecté peut valider ce formulaire car elle l'engage lui personnellement ;
 *  - seule la maison du doctorat de l'établissement d'encadrement peut invalider cette signature.
 */
$canSign = $this->isAllowed($object, EngagementImpartialitePrivileges::ENGAGEMENT_IMPARTIALITE_SIGNER);
$canAnnuler = $this->isAllowed($object, EngagementImpartialitePrivileges::ENGAGEMENT_IMPARTIALITE_ANNULER);

$libelleEntite = $typeProposition === Proposition::ROUTE_PARAM_PROPOSITION_THESE ? "thèse" : "HDR";
$englishlibelleEntite = $typeProposition === Proposition::ROUTE_PARAM_PROPOSITION_THESE ? "thesis" : "HDR";
$doctorantNom = $object->getApprenant()->getIndividu();

$this->headTitle("Engagement d'impartialité portant sur la $libelleEntite de ".$doctorantNom);
?>

<h1 class="page-header">
    Engagement d'impartialité / Impartiality commitment
</h1>

<p>
    Engagement d'impartialité en rapport à la <?= $libelleEntite ?> suivante :
</p>

<div>
    <div class="box card">
        <div class="card-header bg-dark text-white">
            <h2 class="first"> Information sur la <?= $libelleEntite ?> / Information about the PhD <?= $englishlibelleEntite ?> </h2>
        </div>
        <div class="card-body">
            <dl class="row">
                <?php if($typeProposition === Proposition::ROUTE_PARAM_PROPOSITION_THESE): ?>
                    <dt class="col-md-5"> Titre / Title </dt>
                    <dd class="col-md-5"> <?php echo $object->getTitre(); ?> </dd>
                    <dt class="col-md-5"> Doctorant / PhD Student</dt>
                    <dd class="col-md-5"> <?php echo $doctorantNom; ?> </dd>
                    <dt class="col-md-5"> Directeur(s) / Supervisor(s) </dt>
                    <dd class="col-md-5">
                        <?php foreach ($encadrants as $encadrant): ?>
                            <?php
                            /** @var ActeurThese $encadrant */
                            echo $encadrant->getIndividu();
                            ?>
                            <br/>
                        <?php endforeach; ?>
                    </dd>
                    <dt class="col-md-5"> Discipline </dt>
                    <dd class="col-md-5"> <?php echo $object->getDiscipline(); ?> </dd>
                <?php else: ?>
                    <dt class="col-md-5"> Candidat / PhD Student</dt>
                    <dd class="col-md-5"> <?php echo $object->getCandidat(); ?> </dd>
                    <dt class="col-md-5"> Garant(s) / Guarantor(s) </dt>
                    <dd class="col-md-5">
                        <?php foreach ($encadrants as $encadrant): ?>
                            <?php
                            /** @var ActeurHDR $encadrant */
                            echo $encadrant->getIndividu();
                            ?>
                            <br/>
                        <?php endforeach; ?>
                    </dd>
                    <dt class="col-md-5"> Version de diplôme </dt>
                    <dd class="col-md-5"> <?php echo $object->getVersionDiplome(); ?> </dd>
                <?php endif; ?>
                <dt class="col-md-5"> Date de la soutenance </dt>
                <dd class="col-md-5"> <?php echo $proposition->getDate()->format("d/m/Y"); ?> </dd>
                <dt class="col-md-5"> Lieu de la soutenance </dt>
                <dd class="col-md-5"> <?php echo $proposition->getLieu(); ?> </dd>
            </dl>

        </div>
    </div>
</div>

<?php echo $texteEngagement->getCorps(); ?>


<div class="row">
    <div class="col-md-4">
        <?php if ($validation): ?>
            <?php if ($validation->getValidation()->getTypeValidation()->getCode() === TypeValidation::CODE_ENGAGEMENT_IMPARTIALITE):
                echo $this->validation($validation, "success");
            else :
                echo $this->validation($validation, "danger");
            endif; ?>
    <?php else: ?>
        <?php if ($canSign): ?>
        <p>
            <span style="text-align: center">
            <a      <?php /** @see \Soutenance\Controller\EngagementImpartialiteController::signerEngagementImpartialiteAction()  */ ?>
                    href="<?php echo $urlSigner;  ?>"
                    class="btn btn-success" style="width:80%;">
                <span class="fas fa-thumbs-up"></span>
                Je signe / I agree </a>

                <br/>
                <br/>

            <a      <?php /** @see \Soutenance\Controller\EngagementImpartialiteController::refuserEngagementImpartialiteAction()  */ ?>
                    href="<?php echo $urlRefuser;  ?>" class="btn btn-danger" style="width:80%;">
                <span class="fas fa-thumbs-down"></span>
                Je ne signe pas / I disagree </a>
            </span>

        </p>
        <?php else: ?>
        <div class="card">
            <div class="card-header bg-danger">
                Vous n'êtes pas habilité à signer cet engagement d'impartialité.
            </div>
        </div>
        <?php endif; ?>
    <?php endif; ?>
    </div>
    <div class="col-md-8">
        <!-- affichage -->
        <?php if (!$validation): ?>
            <div class="card">
                <div class="card-header bg-warning">
                    Aucune signature.
                </div>
            </div>
        <?php endif; ?>
    </div>
</div>

<?php if ($validation && $validation->getValidation()->getTypeValidation()->getCode() === TypeValidation::CODE_ENGAGEMENT_IMPARTIALITE): ?>
<div class="box card">
    <div class="card-header bg-success">
        <h2 class="first"> Et ensuite ? </h2>
    </div>
    <div class="card-body">

        Vous pouvez maintenant accéder à la partie de remise de votre avis de soutenance et dépôt du pré-rapport de soutenance.
        <nav aria-label="Etape suivante">
            <ul class="roadmap pagination">
            <li>
                <a
                        <?php /** @see \Soutenance\Controller\AvisController::indexAction()  */ ?>
                        class="roadmap-step-link"
                        href="<?php echo $this->url("soutenance_{$typeProposition}/avis-soutenance", ['id' => $object->getId(), 'rapporteur' => $membre->getId()], [], true); ?>">
                    <span class="fas fa-arrow-alt-circle-right"></span>
                        Avis de soutenance
                </a>
            </li>
            </ul>
        </nav>
    </div>
</div>
<?php endif; ?>

<div class="row">
    <div>
        <a href="<?php echo $this->url("soutenance_{$typeProposition}/index-rapporteur", ['id' => $object->getId()], [], true); ?>"
           class="btn btn-primary float-end">
            <span class="icon icon-retour"></span>
           Retour au tableau de bord rapporteur
        </a>
    </div>
</div>