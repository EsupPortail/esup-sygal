# Version 7.0.0

## 1. Sur le serveur d'application

- Désactivez l'import périodique des données Apogée/Physalis.

- Placez-vous dans le répertoire de l'application puis lancez la commande suivante
  pour installer la nouvelle version :

```bash
git fetch --tags && git checkout --force 7.0.0 && bash ./install.sh
```

- Rechargez le moteur PHP, exemple :

```bash
systemctl reload php8.0-fpm
```

## 2. Dans la base de données

- Lancez dans l'ordre les scripts SQL situés dans le répertoire [7.0.0](7.0.0) :
  - [00_substitution_prepare.sql](7.0.0/00_substitution_prepare.sql)
  - [01_substitution.sql](7.0.0/01_substitution.sql)
  - [02_substitution_structure.sql](7.0.0/02_substitution_structure.sql)
  - [03_substitution_etablissement.sql](7.0.0/03_substitution_etablissement.sql)
  - [04_substitution_ecole_doctorale.sql](7.0.0/04_substitution_ecole_doctorale.sql)
  - [05_substitution_unite_recherche.sql](7.0.0/05_substitution_unite_recherche.sql)
  - [06_substitution_individu.sql](7.0.0/06_substitution_individu.sql)
  - [07_substitution_doctorant.sql](7.0.0/07_substitution_doctorant.sql)
  - [08_substitution_autres.sql](7.0.0/08_substitution_autres.sql)

- Puis exécutez ceci :

```postgresql
--
-- Nouvelles fonctions d'ajout/retrait de privileges.
--
create or replace function privilege__grant_privileges_to_profiles(categorycode varchar, privilegecodes varchar[], profileroleids varchar[]) returns void
    language plpgsql
as
$$declare
    v_priv_code varchar;
    v_prof_role_id varchar;
BEGIN
    foreach v_priv_code in ARRAY privilegecodes loop
            foreach v_prof_role_id in ARRAY profileroleids loop
                    insert into profil_privilege (privilege_id, profil_id)
                    select p.id as privilege_id, profil.id as profil_id
                    from profil
                             join categorie_privilege cp on cp.code = categoryCode
                             join privilege p on p.categorie_id = cp.id and p.code = v_priv_code
                    where profil.role_id = v_prof_role_id
                    on conflict do nothing;
                end loop;
        end loop;
    perform privilege__update_role_privilege();
END;
$$;

create or replace function privilege__revoke_privileges_to_profiles(categorycode varchar, privilegecodes varchar[], profileroleids varchar[]) returns void
    language plpgsql
as
$$declare
    v_priv_code varchar;
    v_prof_role_id varchar;
BEGIN
    foreach v_priv_code in ARRAY privilegecodes loop
            foreach v_prof_role_id in ARRAY profileroleids loop
                    delete
                    from profil_privilege pp1
                    where exists(
                        select *
                        from profil_privilege pp
                                 join profil on pp.profil_id = profil.id and role_id = v_prof_role_id
                                 join privilege p on pp.privilege_id = p.id
                                 join categorie_privilege cp on p.categorie_id = cp.id
                        where p.code = v_priv_code
                          and cp.code = categoryCode
                          and pp.profil_id = pp1.profil_id
                          and pp.privilege_id = pp1.privilege_id
                    );
                end loop;
        end loop;
    perform privilege__update_role_privilege();
END;
$$;

--
-- Nouveaux privilèges Substitutions.
--
select privilege__revoke_privileges_to_profiles(
    'substitution',
    ARRAY['automatique','consultation-toutes-structures','consultation-sa-structure','modification-toutes-structures','modification-sa-structure'],
    ARRAY['ADMIN_TECH']
);

delete from privilege where categorie_id = (select id from categorie_privilege where code = 'substitution');

update categorie_privilege set libelle = 'Substitutions' where code = 'substitution';

insert into PRIVILEGE(ID, CATEGORIE_ID, CODE, LIBELLE, ORDRE)
with d(ordre, code, lib) as (
    select 10, 'consulter', 'Consulter les substitutions, doublons, etc.' union all
    select 20, 'modifier', 'Modifier les substitutions'
)
select nextval('privilege_id_seq'), cp.id, d.code, d.lib, d.ordre
from d join CATEGORIE_PRIVILEGE cp on cp.CODE = 'substitution';

select privilege__grant_privileges_to_profiles('substitution', ARRAY['consulter', 'modifier'], ARRAY['ADMIN_TECH']);

```

## 3. Sur le serveur d'application

- Réactivez l'import périodique des données Apogée/Physalis.

