# Version 6.0.6

## 1. Sur le serveur d'application

*Rappel : depuis la version 6.0.0, la version de PHP requise est la 8.0.*

- Placez-vous dans le répertoire de l'application puis lancez la commande suivante
  pour installer la nouvelle version :

```bash
git fetch --tags && git checkout --force 6.0.7 && bash ./install.sh
```

- Rechargez le moteur PHP, exemple :

```bash
systemctl reload php8.0-fpm
```

## 2. Dans la base de données

Rien pour le moment
```postgresql
-- Nouvelles macros
INSERT INTO unicaen_renderer_macro (code, description, variable_name, methode_name) VALUES 
('Soutenance#DateRetourRapport', '<p>Affiche la date de retour des rapports</p>', 'soutenance', 'toStringDateRetourRapport');
-- Nouveaux templates
-- TODO ajouter une fois stable : CONNEXION_RAPPORTEUR
-- TODO ajouter une fois stable : DEMANDE_RAPPORT_SOUTENANCE


alter table formation_module add require_missionenseignement boolean default false not null;
alter table formation_formation add objectif text;
alter table formation_formation add programme text;
alter table formation_seance add lien varchar(1024);
alter table formation_seance add mot_de_passe varchar(256);

-- --------------------------------------------------------
-- Nouveaux roles et profiles de Gestionnaire de formation
-- --------------------------------------------------------

-- Ajout du profil
insert into profil (id, libelle, role_id, structure_type)
with partial(libelle, role_id) AS (
  SELECT 'Gestionnaire de formation', 'GEST_FORM'
)
select nextval('profil_id_seq'), partial.libelle, partial.role_id, ts.id
from partial
       JOIN type_structure ts ON ts.CODE = 'etablissement';

-- Ajout des rôles pour les établissements d'inscriptions
insert into role (
  id,

  code,
  libelle,
  role_id,

  source_code,
  source_id,

  histo_createur_id,

  structure_id,
  type_structure_dependant_id,
  ordre_affichage
)
with partial(code, libelle, role_id, these_dep, ordre_affichage) as (
  SELECT 'GEST_FORM', 'Gestionnaire de formation', 'GEST_FORM', false, 'zzz'
)
select
  nextval('role_id_seq'), --id

  partial.code,  -- code
  concat(concat(concat(partial.libelle, ' ')), etab.source_code), --libelle
  concat(concat(concat(partial.libelle, ' ')), etab.source_code), --role_id

  concat(concat(concat('SYGAL::', partial.role_id), '::'), etab.source_code),
  src.id,

  u.id,

  etab.structure_id,
  s.type_structure_id,
  partial.ordre_affichage
from partial
       join etablissement etab on etab.est_etab_inscription IS TRUE
       join structure s on etab.structure_id = s.id
       join source src on src.code='SYGAL::sygal'
       join utilisateur u on u.username='sygal-app';

-- attacher les rôles au profil
insert into profil_to_role (profil_id, role_id)
select profil.id, role.id from profil
                                 join role on role.code = profil.role_id
where profil.role_id = 'GEST_FORM';

```