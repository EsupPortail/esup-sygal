# Version 6.0.6

## 1. Sur le serveur d'application

*Rappel : depuis la version 6.0.0, la version de PHP requise est la 8.0.*

- Placez-vous dans le répertoire de l'application puis lancez la commande suivante
  pour installer la nouvelle version :

```bash
git fetch --tags && git checkout --force 6.0.7 && bash ./install.sh
```

- Rechargez le moteur PHP, exemple :

```bash
systemctl reload php8.0-fpm
```

## 2. Dans la base de données

Rien pour le moment
```postgresql
-- Nouvelles macros
INSERT INTO unicaen_renderer_macro (code, description, variable_name, methode_name) VALUES 
('Soutenance#DateRetourRapport', '<p>Affiche la date de retour des rapports</p>', 'soutenance', 'toStringDateRetourRapport'),
('Url#PrerapportSoutenance', '<p>Adresse de téléchargement du pré-rapport de soutenance d''un rapporteur</p>', 'Url', 'getPrerapportSoutenance');

-- Nouveaux templates
INSERT INTO unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace) VALUES ('DEMANDE_RAPPORT_SOUTENANCE', '<p>Courrier électronique de demande du rapport de présoutenance à un·e rapporteur·trice</p>', 'mail', 'Demande de rapport de présoutenance pour la thèse de VAR[Doctorant#Denomination]', e'<p><em>-- Version française -----------------------------------------------------------</em><br /><br />Bonjour,</p>
<p>Vous venez d\'être désigné comme rapporteur pour la thèse de VAR[Doctorant#Denomination] intitulée <strong>VAR[These#Titre]</strong>.</p>
<p>Ce courrier électronique a pour but de vous rappeler que vous devez rendre votre avis de soutenance pour la date du <strong>VAR[Soutenance#DateRetourRapport]</strong>.<br />Pour rendre votre avis, connectez-vous à l\'application ESUP-SyGAL en utilisant l\'adresse suivante : VAR[Url#RapporteurDashboard].</p>
<p>Si vous êtes favorable à cette soutenance, nous vous remercions d\'indiquer, à la fin de votre rapport, la mention suivante : « Par conséquent, je suis favorable à la soutenance de thèse de VAR[Doctorant#Denomination] pour obtenir le grade de Docteur de l\'VAR[Etablissement#Libelle] et de l\'Université Normandie.</p>
<p> Cordialement,</p>
<p><em>--  English version -----------------------------------------------------------</em></p>
<p><br />Dear Mrs/Mr,</p>
<p>You have been appointed as an external referee for the PhD thesis presented by VAR[Doctorant#Denomination] entitled <strong>VAR[These#Titre]</strong>.</p>
<p>This mail is a reminder that you have until <strong>VAR[Soutenance#DateRetourRapport]</strong> to submit your report.<br />To do so you can use the following link : VAR[Url#RapporteurDashboard].</p>
<p>For these reasons, I am in favor of VAR[Doctorant#Denomination]\'s thesis defense ; and thus for VAR[Doctorant#Denomination] to be able to claim the title of doctor from VAR[Etablissement#Libelle] and Normandie Université.</p>
<p>Best regards,</p>', null, 'Soutenance\Provider\Template');
INSERT INTO unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace) VALUES ('CONNEXION_RAPPORTEUR', '<p>Courrier électronique envoyé aux rapporteur·trices  pour la connexion à SyGAL</p>', 'mail', 'Connexion en tant que rapporteur de la thèse de VAR[Doctorant#Denomination]', e'<p><em>-- Version française----------------------------------------------------</em><br /><br />Bonjour,</p>
<p>Vous venez d\'être désigné comme rapporteur pour la thèse de VAR[Doctorant#Denomination] intitulée <strong>VAR[These#Titre].</strong> Afin de pouvoir vous connecter à l\'application ESUP-SyGAL et ainsi pouvoir rendre votre avis de pré-soutenance, vous pouvez utiliser l\'adresse suivante : VAR[Url#RapporteurDashboard].<br /><br />Vous avez jusqu\'au <strong>VAR[Soutenance#DateRetourRapport]</strong> pour effectuer ce dépôt.</p>
<p>Si vous êtes favorable à cette soutenance, nous vous remercions d\'indiquer, à la fin de votre rapport, la mention suivante : « Par conséquent, je suis favorable à la soutenance de thèse de VAR[Doctorant#Denomination] pour obtenir le grade de Docteur de l\'VAR[Etablissement#Libelle] et de l\'Université Normandie.</p>
<p> <br />Cordialement,</p>
<p><br /><em>-- English version -----------------------------------------------------</em><br /><br />Dear Mrs/Mr,</p>
<p>You have been appointed as an external referee for the PhD thesis presented by VAR[Doctorant#Denomination] entitled <strong>VAR[These#Titre]</strong>. In order to have access to ESUP-SyGAL  web-based application for submitting your report, you can use the following link : VAR[Url#RapporteurDashboard].</p>
<p>You have until the <strong>VAR[Soutenance#DateRetourRapport]</strong> to upload your report.</p>
<p>For these reasons, I am in favor of VAR[Doctorant#Denomination]\'s thesis defense ; and thus for VAR[Doctorant#Denomination] to be able to claim the title of doctor from VAR[Etablissement#Libelle] and Normandie Université.<br /><br /></p>
<p>Best regards,<br /><br /><br /></p>
<p> </p>', null, 'Soutenance\Provider\Template');
INSERT INTO unicaen_renderer_template (code, description, document_type, document_sujet, document_corps, document_css, namespace) VALUES ('SOUTENANCE_AVIS_FAVORABLE', null, 'mail', 'VAR[Acteur#Denomination] vient de rendre un avis favorable pour la thèse de VAR[Doctorant#Denomination]', e'<p>Bonjour,</p>
<p>Le rapporteur VAR[Acteur#Denomination] vient de rendre un avis favorable pour la thèse de VAR[Doctorant#Denomination] intitulée VAR[These#Titre].</p>
<p>Vous pouvez consulter le rapport de pré-soutenance en allant sur la page de gestion de la soutenance VAR[Url#SoutenanceProposition] ou en utilisante le lien suivant : VAR[Url#PrerapportSoutenance]</p>
<p>Vous avez reçu ce courrier électronique car :</p>
<ul>
<li>un avis favorable a été rendu par un rapporteur</li>
<li>vous êtes soit :
<ul>
<li>un·e gestionnaire de la maison du doctorat de l\'établissement d\'inscription du doctorant</li>
<li>un·e responsable de l\'école doctorale gérant la thèse de VAR[Doctorant#Denomination]</li>
<li>un·e responsable de l\'unité de recherche accueillant la thèse de VAR[Doctorant#Denomination]</li>
<li>une personne participant à la direction de la thèse de VAR[Doctorant#Denomination]</li>
</ul>
</li>
</ul>', null, 'Soutenance\Provider\Template');




alter table formation_module add require_missionenseignement boolean default false not null;
alter table formation_formation add objectif text;
alter table formation_formation add programme text;
alter table formation_seance add lien varchar(1024);
alter table formation_seance add mot_de_passe varchar(256);

-- --------------------------------------------------------
-- Nouveaux roles et profiles de Gestionnaire de formation
-- --------------------------------------------------------

-- Ajout du profil
insert into profil (id, libelle, role_id, structure_type)
with partial(libelle, role_id) AS (
  SELECT 'Gestionnaire de formation', 'GEST_FORM'
)
select nextval('profil_id_seq'), partial.libelle, partial.role_id, ts.id
from partial
       JOIN type_structure ts ON ts.CODE = 'etablissement';

-- Ajout des rôles pour les établissements d'inscriptions
insert into role (
  id,

  code,
  libelle,
  role_id,

  source_code,
  source_id,

  histo_createur_id,

  structure_id,
  type_structure_dependant_id,
  ordre_affichage
)
with partial(code, libelle, role_id, these_dep, ordre_affichage) as (
  SELECT 'GEST_FORM', 'Gestionnaire de formation', 'GEST_FORM', false, 'zzz'
)
select
  nextval('role_id_seq'), --id

  partial.code,  -- code
  concat(concat(concat(partial.libelle, ' ')), etab.source_code), --libelle
  concat(concat(concat(partial.libelle, ' ')), etab.source_code), --role_id

  concat(concat(concat('SYGAL::', partial.role_id), '::'), etab.source_code),
  src.id,

  u.id,

  etab.structure_id,
  s.type_structure_id,
  partial.ordre_affichage
from partial
       join etablissement etab on etab.est_etab_inscription IS TRUE
       join structure s on etab.structure_id = s.id
       join source src on src.code='SYGAL::sygal'
       join utilisateur u on u.username='sygal-app';

-- attacher les rôles au profil
insert into profil_to_role (profil_id, role_id)
select profil.id, role.id from profil
                                 join role on role.code = profil.role_id
where profil.role_id = 'GEST_FORM';

```